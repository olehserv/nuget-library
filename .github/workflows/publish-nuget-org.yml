name: Publish NuGet (nuget.org)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  publish-nuget-org:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"
          cache: true

      - name: Restore
        run: dotnet restore

      - name: Build (Release)
        run: dotnet build -c Release --no-restore

      - name: Pack (src only, version from tag)
        shell: bash
        env:
          NUGET_ID_PREFIX: ${{ vars.NUGET_ID_PREFIX }}
        run: |
          TAG="${GITHUB_REF_NAME}"   
          VERSION="${TAG#v}"         
          echo "Packing version: $VERSION"
          echo "Using PackageId prefix: ${NUGET_ID_PREFIX}"

          rm -rf artifacts
          mkdir -p artifacts

          # packing all projects from src/
          while IFS= read -r -d '' CSPROJ; do
            # take package ID from assembly file (csproj)
            BASE_ID=$(dotnet msbuild "$CSPROJ" -nologo -t:GetProperty -p:PropertyName=PackageId | tail -n 1)
            
            # if no PackageId, use .csproj file name
            if [ -z "$BASE_ID" ]; then
              BASE_ID=$(basename "$CSPROJ" .csproj)
            fi

            FULL_ID="${NUGET_ID_PREFIX}${BASE_ID}"
            echo "Packing: $CSPROJ as $FULL_ID"

            dotnet pack "$CSPROJ" -c Release --no-build \
              -p:PackageVersion="$VERSION" \
              -p:PackageId="$FULL_ID" \
              -o artifacts
          done < <(find src -name '*.csproj' -print0)

      # Retrieve temp NuGet API key
      - name: NuGet login
        id: nuget_login
        uses: NuGet/login@v1
        with:
          user: ${{ vars.NUGET_USERNAME }}

      - name: Push packages (.nupkg) from artifacts
        shell: bash
        run: |
          dotnet nuget push "artifacts/*.nupkg" \
            --source "https://api.nuget.org/v3/index.json" \
            --api-key "${{ steps.nuget_login.outputs.NUGET_API_KEY }}" \
            --skip-duplicate

      - name: Push symbols (.snupkg) from artifacts
        shell: bash
        run: |
          dotnet nuget push "artifacts/*.snupkg" \
            --source "https://api.nuget.org/v3/index.json" \
            --api-key "${{ steps.nuget_login.outputs.NUGET_API_KEY }}" \
            --skip-duplicate